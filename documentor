#!/bin/bash

# DocuMentor launcher with Go TUI integration
# This script launches the documentor with the Go TUI for visual progress tracking

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TUI_DIR="$SCRIPT_DIR/src/tui"
TUI_BINARY="$TUI_DIR/documentor-tui"

# Parse command to determine if we should use TUI
USE_TUI=true
for arg in "$@"; do
  case "$arg" in
    --no-tui)
      USE_TUI=false
      ;;
    config|--help|-h|--version|-v)
      # Don't use TUI for these commands
      USE_TUI=false
      ;;
  esac
done

# If not using TUI, run directly
if [ "$USE_TUI" = false ]; then
  npm run start -- "$@"
  exit $?
fi

# Check if TUI binary exists and build if necessary
if [ ! -f "$TUI_BINARY" ]; then
  echo "Building Go TUI..."
  cd "$TUI_DIR"
  go build -o documentor-tui main.go updateInfoBox.go password_modal_simple.go
  if [ $? -ne 0 ]; then
    echo "Failed to build TUI. Running without TUI..."
    cd "$SCRIPT_DIR"
    npm run start -- "$@"
    exit $?
  fi
  cd "$SCRIPT_DIR"
fi

# Create a named pipe for communication
PIPE=$(mktemp -u)
mkfifo "$PIPE"

# Cleanup function
cleanup() {
  rm -f "$PIPE"
  kill $TUI_PID 2>/dev/null
  exit $1
}

# Set up trap for cleanup
trap 'cleanup $?' EXIT INT TERM

# Start the TUI with the pipe as input
"$TUI_BINARY" < "$PIPE" &
TUI_PID=$!

# Run documentor and pipe output to TUI
(
  # Run the TypeScript documentor
  npm run start -- "$@" > "$PIPE" 2>&1
  RESULT=$?
  
  # Send completion message
  if [ $RESULT -eq 0 ]; then
    echo '{"type":"log","level":"success","content":"Documentation generation completed successfully"}' > "$PIPE"
  else
    echo '{"type":"log","level":"error","content":"Documentation generation failed"}' > "$PIPE"
  fi
  
  # Give TUI time to display the final message
  sleep 2
  
  # Send quit signal (TUI will exit gracefully)
  kill $TUI_PID 2>/dev/null
) &
DOCUMENTOR_PID=$!

# Wait for the documentor to complete
wait $DOCUMENTOR_PID
DOCUMENTOR_EXIT=$?

# Wait for TUI to exit
wait $TUI_PID 2>/dev/null

# Exit with documentor's exit code
exit $DOCUMENTOR_EXIT